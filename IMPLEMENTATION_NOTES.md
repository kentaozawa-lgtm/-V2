# 実装ノート

## 実装完了機能

### ✅ 完了した機能

1. **認証機能**
   - ログイン画面
   - Supabase Auth連携
   - ミドルウェアでの認証チェック
   - ログアウト機能

2. **領収書撮影・アップロード**
   - カメラ起動（スマホ対応）
   - 画像選択（アルバムから）
   - 画像圧縮（クライアント側）
   - Supabase Storageアップロード

3. **AI解析（Gemini）**
   - 画像→テキスト抽出
   - 構造化JSON出力
   - マスタデータを考慮した候補提示
   - エラーハンドリング

4. **解析結果確認・編集**
   - フォーム入力
   - マスタからの選択（Select）
   - 下書き保存
   - バリデーション

5. **領収書一覧**
   - 月フィルタ
   - ステータスフィルタ
   - 社員/経理での表示切り替え
   - カード型レイアウト（スマホ最適）

6. **領収書詳細**
   - 画像表示
   - 全項目表示
   - 差し戻し情報表示
   - ステータスバッジ

7. **CSV出力**
   - 月次単位
   - freee会計用フォーマット
   - BOM付きUTF-8（Excel対応）
   - 出力後のステータス更新

8. **共通UI**
   - レスポンシブレイアウト
   - ヘッダー・フッターナビ
   - Toastによる通知
   - 一貫したカラー・スタイル

### 🚧 未実装（今回スコープ外）

1. **領収書編集画面（経理用）**
   - `/receipts/[id]/edit`
   - 差し戻し機能
   - 承認機能
   - 修正箇所チェックボックス

2. **マスタ管理画面**
   - `/admin/masters`
   - 勘定科目/税区分/支払方法の追加・編集・無効化
   - タブ切り替え

3. **CSV出力履歴**
   - `/admin/exports`
   - 過去の出力履歴表示
   - 再ダウンロード

4. **差し戻し時の修正画面**
   - 社員が差し戻し対応する専用画面
   - 修正箇所のハイライト

5. **一括承認機能**
   - 複数選択
   - まとめて承認
   - 必須項目チェック

## 実装時の工夫

### スマホ最適化

- **タッチターゲット**: ボタン最小48px（Googleガイドライン）
- **フォントサイズ**: 16px（iOS拡大防止）
- **固定ナビ**: 下部固定で親指届く範囲
- **カメラ**: `facingMode: 'environment'` で背面カメラ優先

### パフォーマンス

- **画像圧縮**: クライアント側で1600px、品質0.8
- **Server Components**: 可能な限り使用
- **RLS**: Supabaseで権限制御

### UX

- **ローディング**: 処理中の状態表示
- **エラー**: わかりやすいメッセージ
- **バリデーション**: リアルタイム表示
- **Toast**: 完了・エラー通知

## デプロイ手順

### Vercelへのデプロイ

1. GitHubリポジトリにpush
2. Vercelでプロジェクト作成
3. 環境変数を設定:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `GEMINI_API_KEY`
4. デプロイ

### 本番環境の注意点

- **HTTPS必須**: カメラAPI使用のため
- **環境変数**: 本番用の値に変更
- **Supabase**: 本番プロジェクトを使用
- **Gemini API**: クォータ・課金設定確認

## テストユーザーの作成

```sql
-- 組織作成
INSERT INTO organizations (name) VALUES ('テスト株式会社');

-- 経理ユーザー（admin）
-- 1. Supabase Auth でユーザー作成
-- 2. プロファイル作成
INSERT INTO profiles (id, email, display_name, organization_id, role)
VALUES (
  'auth-user-uuid',
  'admin@test.com',
  '経理 太郎',
  '組織のUUID',
  'admin'
);

-- 社員ユーザー（member）
INSERT INTO profiles (id, email, display_name, organization_id, role)
VALUES (
  'auth-user-uuid-2',
  'member@test.com',
  '社員 花子',
  '組織のUUID',
  'member'
);
```

## 今後の改善案

### 短期（v1.1）

- [ ] 領収書編集画面の実装
- [ ] マスタ管理画面の実装
- [ ] 一括承認機能
- [ ] 差し戻し時の修正フロー改善

### 中期（v2.0）

- [ ] freee API直接連携
- [ ] 経費精算ワークフロー
- [ ] 画像内のテキスト位置可視化
- [ ] OCR精度向上

### 長期（v3.0）

- [ ] スマホアプリ化（React Native）
- [ ] オフライン対応
- [ ] 複数組織サポート
- [ ] ダッシュボード・分析機能

## トラブルシューティング

### よくある問題

1. **"Failed to parse Gemini response"**
   - Gemini APIのレスポンスがJSON形式でない
   - プロンプトを調整して確実にJSONを返させる
   - マークダウンのコードブロック除去処理を確認

2. **"カメラの利用を許可してください"**
   - HTTPSでないとカメラAPIが使えない
   - ローカルは http://localhost のみOK
   - 本番は必ずHTTPS

3. **"データベースエラーが発生しました"**
   - RLSポリシーを確認
   - 外部キー制約を確認
   - Supabaseログを確認

4. **画像が表示されない**
   - Supabase Storage のバケット設定確認
   - Public アクセス設定を確認
   - CORS設定を確認

## パフォーマンスチェックリスト

- [ ] 画像は圧縮してアップロード
- [ ] 不要なデータフェッチを削減
- [ ] Server Components を活用
- [ ] 適切なキャッシング
- [ ] Lazy Loading（必要に応じて）

## セキュリティチェックリスト

- [ ] RLS が全テーブルで有効
- [ ] 環境変数は `.env.local` のみ
- [ ] API キーは公開しない
- [ ] XSS対策（Reactが自動で対応）
- [ ] CSRF対策（Next.jsが自動で対応）

## コード品質

### TypeScript

- 型安全性を最大限活用
- `any` は最小限（AI解析結果のみ）
- Database型は自動生成を推奨

### コンポーネント設計

- Server/Client Componentを適切に分離
- 再利用可能なコンポーネントを作成
- プロップスは明確に型定義

### スタイリング

- Tailwind CSSを統一的に使用
- shadcn/uiのコンポーネントを活用
- カスタムCSSは最小限
